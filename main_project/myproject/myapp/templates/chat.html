<!DOCTYPE html>
<html lang="ru">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with AI</title>
    <link rel="stylesheet" href="{% static 'CSS/chat.css' %}">
    <!-- –î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–≥–∏–µ CSS —Ñ–∞–π–ª—ã –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
</head>
<body>
    <div class="chat-container">
        <div class="header">
            {% if user.is_authenticated %}
                <button id="logout-button" class="logout-button" onclick="handleLogout()">
                    –í—ã–π—Ç–∏
                </button>
            {% else %}
                <button class="auth-button" id="login-button">
                    –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                </button>
            {% endif %}
            <h1>Chat with AI</h1>
            <button id="theme-toggle" class="theme-toggle-button">
                <span id="theme-icon" class="icon">üåô</span>
            </button>
            {% if user.is_authenticated %}
                <button id="toggle-chats" class="theme-toggle-button" onclick="toggleChatsPanel()">‚ò∞</button>
            {% endif %}
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —á–∞—Ç–æ–≤ -->
        <div class="chats-panel" id="chats-panel">
            <div class="chats-header">
                <h2>–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h2>
                <button class="close-chats" onclick="closeChatsPanel()">√ó</button>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ -->
            <button id="new-chat-btn" class="new-chat-button" onclick="createNewChat()">–ù–æ–≤—ã–π —á–∞—Ç</button>
            
            <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ -->
            <div class="chats-list">
                {% for chat in chats %}
                    <div class="chat-item {% if chat.id == current_chat.id %}active{% endif %}" 
                         onclick="switchChat({{ chat.id }})">
                        <span class="chat-name">{{ chat.name }}</span>
                        <div class="chat-actions">
                            <button class="rename-chat" onclick="renameChat(event, {{ chat.id }}, '{{ chat.name }}')" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">‚úé</button>
                            <button class="delete-chat" onclick="deleteChat(event, {{ chat.id }})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="user-info" style="display: flex; justify-content: space-between; align-items: center;">
            {% if user.is_authenticated %}
                <div class="user-name">–ü—Ä–∏–≤–µ—Ç, {{ user.username }}</div>
            {% endif %}
            <button id="history-button" style="display: {% if user.is_authenticated %} inline {% else %} none {% endif %};">–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>
        
        <div class="chat-box" id="chat-box">
            <div class="message-container ai">
                <div class="message">AI: –ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å–µ–≥–æ–¥–Ω—è?</div>
            </div>
        </div>
        
        <div class="input-container" style="display: flex; align-items: center;">
            <input type="text" id="user-input" placeholder="{% if user.is_authenticated %}Type a message...{% else %}–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ{% endif %}" {% if not user.is_authenticated %}disabled{% endif %} />
            <button class="send-button" id="send-button" {% if not user.is_authenticated %}disabled{% endif %}>‚û§</button>
        </div>
        
        <div id="alert-message" class="alert" style="display: none;"></div>

        
        <div id="history-container" style="display: none;">
            <h2>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</h2>
            <div class="chat-box" id="history-box">
                {% for message in messages|dictsort:"created_at" reversed %}
                    <div class="message-container user">
                        <div class="message">–í—ã: {{ message.user_message }}</div>
                    </div>
                    <div class="message-container ai">
                        <div class="message">AI: {{ message.ai_response }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        async function handleLogout() {
            try {
                const response = await fetch('/logout/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                    localStorage.clear();
                    sessionStorage.clear();

                    // –û—á–∏—â–∞–µ–º –∫—É–∫–∏ Google Auth
                    document.cookie.split(";").forEach(function(c) { 
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                    });

                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    window.location.reload();
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const themeIcon = document.getElementById('theme-icon');
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –≤ localStorage
            if (document.body.classList.contains('dark-theme')) {
                themeIcon.textContent = '‚òÄÔ∏è'; // –ò–∫–æ–Ω–∫–∞ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.textContent = 'üåô'; // –ò–∫–æ–Ω–∫–∞ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
                localStorage.setItem('theme', 'light');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è'; // –ò–∫–æ–Ω–∫–∞ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã
            } else {
                document.getElementById('theme-icon').textContent = 'üåô'; // –ò–∫–æ–Ω–∫–∞ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
            }

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
        };

        document.getElementById('send-button').addEventListener('click', sendMessage);
        document.getElementById('user-input').addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });

        function addTypingIndicator() {
            const chatBox = document.getElementById('chat-box');
            return chatBox.innerHTML += `
                <div class="message-container ai" id="typing-indicator">
                    <div class="message typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>`;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function sendMessage() {
            const userInput = document.getElementById('user-input').value.trim();
            const chatBox = document.getElementById('chat-box');
            const alertMessage = document.getElementById('alert-message');

            if (!userInput) {
                alertMessage.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.';
                alertMessage.style.display = 'block';
                return;
            }

            chatBox.innerHTML += `<div class="message-container user"><div class="message">–í—ã: ${userInput}</div></div>`;
            document.getElementById('user-input').value = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è
            addTypingIndicator();
            chatBox.scrollTop = chatBox.scrollHeight;

            fetch('/messages/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ 
                    user_message: userInput
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è
                removeTypingIndicator();
                chatBox.innerHTML += `<div class="message-container ai"><div class="message">AI: ${data.ai_response}</div></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                removeTypingIndicator();
                chatBox.innerHTML += `<div class="message-container ai"><div class="message">AI: –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div></div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        document.getElementById('history-button').addEventListener('click', () => {
            const historyContainer = document.getElementById('history-container');
            if (historyContainer.style.display === 'none') {
                historyContainer.style.display = 'block';
            } else {
                historyContainer.style.display = 'none';
            }
        });

        // –î–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
        window.addEventListener('message', function(event) {
            if (event.data.type === 'auth_success') {
                location.reload();
            }
        });

        // –û–±–Ω–æ–≤–∏–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞
        document.getElementById('login-button').addEventListener('click', function(e) {
            e.preventDefault();
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Google –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
            const width = 600;
            const height = 600;
            const left = (window.innerWidth - width) / 2;
            const top = (window.innerHeight - height) / 2;
            
            window.open(
                '/accounts/google/login/',
                'Google Login',
                `width=${width},height=${height},left=${left},top=${top}`
            );
        });

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª—å—é —á–∞—Ç–æ–≤
        function toggleChatsPanel() {
            document.getElementById('chats-panel').classList.toggle('show');
        }

        function closeChatsPanel() {
            document.getElementById('chats-panel').classList.remove('show');
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
        function createNewChat() {
            const chatName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:', '–ù–æ–≤—ã–π —á–∞—Ç');
            
            if (chatName !== null) {
                fetch('/api/chats/', {  // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π URL –¥–ª—è API
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        name: chatName
                    }),
                    credentials: 'include'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.id) {  // –ü—Ä–æ–≤–µ—Ä—è–µ–º id —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —á–∞—Ç–∞
                        window.location.href = `/chat/?chat_id=${data.id}`;
                    } else {
                        throw new Error('Chat ID not received');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–∞: ' + error.message);
                });
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —á–∞—Ç–∞–º–∏
        function switchChat(chatId) {
            window.location.href = `/chat/?chat_id=${chatId}`;
        }

        // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —á–∞—Ç–∞
        function renameChat(event, chatId, currentName) {
            event.stopPropagation();
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:', currentName);
            
            if (newName && newName.trim() !== currentName) {
                fetch(`/api/chats/${chatId}/rename/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName.trim() })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    location.reload();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ —á–∞—Ç–∞: ' + error.message);
                });
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞
        function deleteChat(event, chatId) {
            event.stopPropagation();
            
            if(confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')) {
                fetch(`/api/chats/${chatId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if(data.redirect_to) {
                        window.location.href = data.redirect_to;
                    } else {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Ç–∞: ' + error.message);
                });
            }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ localStorage
        window.addEventListener('storage', function(e) {
            // –ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞
            if (e.key === 'refresh_chat_trigger') {
                location.reload();
            }
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å
        document.addEventListener('DOMContentLoaded', function() {
            const lastRefresh = localStorage.getItem('refresh_chat_trigger');
            const lastChecked = sessionStorage.getItem('last_refresh_checked');
            
            if (lastRefresh && lastRefresh !== lastChecked) {
                sessionStorage.setItem('last_refresh_checked', lastRefresh);
                location.reload();
            }
        });
    </script>

    <style>
    .logout-button {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }

    .logout-button:hover {
        background-color: #c82333;
    }

    .auth-button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
    }

    .auth-button:hover {
        background-color: #0056b3;
    }

    .header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
    }

    .header h1 {
        margin: 0 auto;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∞–Ω–∏—è */
    .typing-indicator {
        background-color: #e0e0e0;
        padding: 15px;
        border-radius: 15px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 5px;
        width: fit-content;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: #666;
        border-radius: 50%;
        display: inline-block;
        animation: typing 1s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) {
        animation-delay: 0.1s;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.3s;
    }

    @keyframes typing {
        0%, 100% {
            transform: translateY(0);
            opacity: 0.3;
        }
        50% {
            transform: translateY(-5px);
            opacity: 1;
        }
    }

    /* –î–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    .dark-theme .typing-indicator {
        background-color: #2c2c2c;
    }

    .dark-theme .typing-indicator span {
        background-color: #999;
    }

    .chats-panel {
        position: fixed;
        top: 0;
        right: -350px;
        width: 300px;
        height: 100%;
        background-color: #f5f5f5;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1000;
        padding: 20px;
        box-sizing: border-box;
    }

    .dark-theme .chats-panel {
        background-color: #1e1e1e;
        color: white;
    }

    .chats-panel.show {
        right: 0;
    }

    .chats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .close-chats {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: inherit;
    }

    .new-chat-button {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .chat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        cursor: pointer;
    }

    .chat-item:hover {
        background-color: rgba(0, 0, 0, 0.1);
    }

    .chat-item.active {
        background-color: rgba(0, 0, 0, 0.2);
    }

    .chat-actions {
        display: none;
    }

    .chat-item:hover .chat-actions {
        display: flex;
    }

    .rename-chat, .delete-chat {
        padding: 5px;
        margin-left: 5px;
        border: none;
        background: none;
        cursor: pointer;
        color: inherit;
    }
    </style>
</body>
</html>